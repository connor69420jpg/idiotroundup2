import Anthropic from "@anthropic-ai/sdk";

// Known repost/aggregator accounts to specifically search for
const KNOWN_REPOST_ACCOUNTS = {
  tiktok: [
    "countrycentral", "barstoolsports", "zachbryanarchive", "oklahomanoutlaw",
    "whiskeyriff", "countrychord", "countrymusictiktok", "nashvillevibes",
    "countrymusicnation", "savagecountry", "countryrap", "wideopen_country",
    "countryrebel", "thebootofficial", "tasteofcountry",
    "countryconcerts", "concertvibes", "concertjunkie", "festivalszn",
    "viralcountry", "countrylyfe", "honkytonkhighway",
    "morezachbryan", "zachbryanedits", "zachbryansongs"
  ],
  instagram: [
    "whiskeyriff", "countrycentral", "barstoolsports", "zachbryanarchive",
    "countrychord", "tasteofcountry", "countryrebel",
    "theboot", "wideopencountry", "countrymusic", "nashvillelifestyles",
    "countryconcertvibes", "countrynation", "cmt", "iheartcountry",
    "savagecountry", "honkytonklife", "tmz", "billboard", "rollingstone"
  ],
  youtube: [
    "CountryChord", "WhiskeyRiff", "TasteOfCountry", "CountryRebel",
    "TMX", "BarstoolSports", "CMT", "CountryCentral", "CountryNow"
  ]
};

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  const apiKey = process.env.ANTHROPIC_API_KEY;
  if (!apiKey) {
    return res.status(500).json({ error: "ANTHROPIC_API_KEY not configured" });
  }

  try {
    const { url, platform, metadata } = req.body;

    if (!url || !platform) {
      return res.status(400).json({ error: "Missing url or platform" });
    }

    const client = new Anthropic({ apiKey });

    // Extract key identifiers from the URL and metadata
    const videoId = extractVideoId(url, platform);
    const author = metadata?.author || "unknown";
    const title = metadata?.title || "unknown";

    // Build a comprehensive, targeted prompt
    const searchPrompt = buildSearchPrompt(url, platform, author, title, videoId);

    const message = await client.messages.create({
      model: "claude-sonnet-4-20250514",
      max_tokens: 2000,
      system: `You are a specialist at finding reposted/stolen video content across social media platforms. You are thorough and persistent. You will perform MULTIPLE web searches to find every instance of a video being reposted.

Your job:
1. Search for the original video to understand its content, title, hashtags, and key details.
2. Search specifically for known repost/aggregator accounts that may have reposted it.
3. Search across TikTok, Instagram, YouTube, Facebook, and Twitter/X.
4. Look for both exact reposts AND articles/embeds that use the video.

Return ONLY a valid JSON array. Each object must have:
- "platform": tiktok, instagram, youtube, facebook, twitter, or website
- "account_name": the account or site that reposted (e.g. @countrycentral or "Whiskey Riff")
- "url": direct link to the repost
- "confidence": "high" (exact repost or confirmed embed) or "medium" (likely repost based on context)
- "date_found": approximate date in YYYY-MM-DD format
- "type": "repost" (re-uploaded the video), "embed" (article embedding the original), or "reaction" (used clips in their own video)

Do NOT include the original video URL. Only include DIFFERENT accounts/pages that used the content.
Return ONLY the JSON array, no other text.`,
      messages: [
        {
          role: "user",
          content: searchPrompt
        }
      ],
      tools: [
        {
          type: "web_search_20250305",
          name: "web_search",
        }
      ]
    });

    // Extract text blocks
    const textBlocks = message.content
      .filter((block) => block.type === "text")
      .map((block) => block.text)
      .join("\n");

    // Parse JSON results
    let results = [];
    try {
      const cleaned = textBlocks.replace(/```json|```/g, "").trim();
      const jsonMatch = cleaned.match(/\[[\s\S]*\]/);
      if (jsonMatch) {
        results = JSON.parse(jsonMatch[0]);
      }
    } catch (parseErr) {
      console.error("JSON parse error:", parseErr.message);
      return res.status(200).json({ results: [], rawText: textBlocks });
    }

    // Deduplicate by URL
    const seen = new Set();
    results = results.filter((r) => {
      const key = r.url?.toLowerCase();
      if (!key || seen.has(key)) return false;
      // Filter out the original video
      if (videoId && key.includes(videoId)) return false;
      seen.add(key);
      return true;
    });

    return res.status(200).json({ results });
  } catch (err) {
    console.error("API error:", err.message);
    return res.status(500).json({ error: err.message });
  }
}

function extractVideoId(url, platform) {
  try {
    const u = new URL(url);
    const parts = u.pathname.split("/").filter(Boolean);
    if (platform === "tiktok") {
      const videoIdx = parts.indexOf("video");
      if (videoIdx !== -1 && parts[videoIdx + 1]) return parts[videoIdx + 1];
    }
    if (platform === "instagram") {
      const reelIdx = parts.indexOf("reel") !== -1 ? parts.indexOf("reel") : parts.indexOf("reels");
      if (reelIdx !== -1 && parts[reelIdx + 1]) return parts[reelIdx + 1];
    }
    if (platform === "youtube") {
      if (u.pathname.includes("/shorts/")) {
        return parts[parts.indexOf("shorts") + 1];
      }
      return u.searchParams.get("v") || parts[parts.length - 1];
    }
  } catch {}
  return "";
}

function buildSearchPrompt(url, platform, author, title, videoId) {
  return `Find ALL reposts and uses of this video across the internet:

ORIGINAL VIDEO:
- URL: ${url}
- Platform: ${platform}
- Author: ${author}
- Video ID: ${videoId}

SEARCH STRATEGY â€” please perform ALL of these searches:

1. First, search for the original video to understand its exact content, title, description, and hashtags.

2. Then search SPECIFICALLY for these known repost accounts that commonly repost country/Nashville/viral content. Check each one for this video:
   TikTok accounts to check: @countrycentral, @barstoolsports, @zachbryanarchive, @oklahomanoutlaw, @whiskeyriff, @countrychord, @viralcountry, @morezachbryan, @concertvibes
   Instagram accounts to check: @whiskeyriff, @countrycentral, @barstoolsports, @tasteofcountry, @countryrebel, @cmt, @billboard

3. Search for the video content being shared on news/blog sites like:
   whiskeyriff.com, tasteofcountry.com, billboard.com, rollingstone.com, stereogum.com, countryrebel.com, distractify.com, boredpanda.com

4. Search YouTube for re-uploads: "${author}" + key description terms from the video

5. Search Twitter/X for this video being shared by aggregator accounts

6. Do additional broad searches using the video's hashtags and description to find ANY other accounts that reposted it.

Be extremely thorough. Perform at least 5-8 different searches. This video may have gone very viral, so there could be MANY reposts across different platforms. Find as many as you can.`;
}
